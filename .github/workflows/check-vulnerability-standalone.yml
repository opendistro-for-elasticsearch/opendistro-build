name: Standalone Vulnerability Scan

on:
#  repository_dispatch:
#    types: [check-vulnerability-standalone]
  push:
    branches: [sreekarj_V295794338]

#env:
#  RUNNER_ID: ${{ GITHUB_RUN_ID }} 


jobs:
#  Provision-Runners:
#    name: Provision-Runners
#    runs-on: ubuntu-18.04
#    steps:
#      - uses: actions/checkout@v1
#      - name: Configure AWS Credentials
#        uses: aws-actions/configure-aws-credentials@v1
#        with:
#          aws-access-key-id: ${{ secrets.AWS_EC2_ACCESS_KEY_ID }}
#          aws-secret-access-key: ${{ secrets.AWS_EC2_SECRET_ACCESS_KEY }}
#          aws-region: us-west-2
#      - name: AWS Cli Processing
#        run: |
         #RUNNERS="odfe-wss-scan-${GITHUB_RUN_ID}"
#          RUNNERS=$RUNNER_ID
#          release-tools/scripts/setup_runners.sh run $RUNNERS ${{ secrets.ODFE_RELEASE_BOT_PUBLIC_PRIVATE_READ_WRITE_TOKEN }}

  whitesource-vulnerability-scan:
#    needs: [Provision-Runners]
    name: WhiteSource Vulnerability Scan
    runs-on: ubuntu-18.04
#    runs-on:
#    - self-hosted
#    - Linux
#    - X64
#    - ${GITHUB_RUN_ID}
    strategy:
      fail-fast: false
      matrix:
        java: [11]
    steps:
      - uses: actions/checkout@v1
      - name: Setup Java
        uses: actions/setup-java@v1
        with:
          java-version: ${{ matrix.java }}
      - name: Vulnerability Scan
        id: vulnerability_scan
        env:
          wss_apikey: ${{ secrets.WSS_API_KEY }}
        run: |
          export PATH=$JAVA_HOME:$PATH
          cd standalone-tools ; ls -ltr 
          #sudo yum install -y maven
          #wget -q https://services.gradle.org/distributions/gradle-6.7-bin.zip
          #sudo mkdir /opt/gradle
          #sudo unzip -d /opt/gradle gradle-6.7-bin.zip
          #wget -qO - https://rpm.nodesource.com/setup_14.x | sudo bash -
          #sudo yum install -y nodejs
          #wget -qO - https://dl.yarnpkg.com/rpm/yarn.repo | sudo tee /etc/yum.repos.d/yarn.repo
          #sudo rpm --import https://dl.yarnpkg.com/rpm/pubkey.gpg
          #sudo yum install yarn -y
          #export PATH=$PATH:/opt/gradle/gradle-6.7/bin
          gradle -v; mvn -v ; npm -v; yarn -v
          tag=master
          repo=index-management
          git clone --branch $tag --single-branch https://github.com/opendistro-for-elasticsearch/$repo.git
          wget -q https://github.com/whitesource/unified-agent-distribution/releases/latest/download/wss-unified-agent.jar
          ls -ltr
          java -jar wss-unified-agent.jar -c wss-unified-agent.config -d $repo -apiKey $wss_apikey -product ODFE -project $repo
          cat whitesource/*/*


#  CleanUp-Runners:
#    needs: [whitesource-vulnerability-scan]
#    if: always()
#    name: CleanUp-Runners
#    runs-on: ubuntu-18.04
#    steps:
#      - uses: actions/checkout@v1
#      - name: Configure AWS Credentials
#        uses: aws-actions/configure-aws-credentials@v1
#        with:
#          aws-access-key-id: ${{ secrets.AWS_EC2_ACCESS_KEY_ID }}
#          aws-secret-access-key: ${{ secrets.AWS_EC2_SECRET_ACCESS_KEY }}
#          aws-region: us-west-2
#      - name: AWS Cli Processing
#        run: |
#          RUNNERS=$RUNNER_ID
#          release-tools/scripts/setup_runners.sh terminate $RUNNERS ${{ secrets.ODFE_RELEASE_BOT_PUBLIC_PRIVATE_READ_WRITE_TOKEN }}

